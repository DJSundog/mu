#!/bin/bash
# Repeatedly stop building until successive layers, and run all tests built.

set -e

cd `dirname $0`
for f in [0-9]*
do
  echo "=== $f"
  ./build_and_test_until $f  ||  exit 1
done

./clean top
for f in examples/ex*.subx apps/*.subx
do
  echo checking $f
  target=`echo $f |sed 's/\..*//'`
  CFLAGS=-g ./subx translate $f $target
  git diff --quiet $target  ||  exit 1
  echo $target generated as expected
done
